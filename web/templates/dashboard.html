<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maybee ‚Ä¢ Tableau de bord</title>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #050505;
            --panel: #0A0A0B;
            --text: #F5F5F7;
            --muted: #A3A3B0;
            --line: rgba(255,255,255,.1);
            --amber: #F59E0B;
            --accent-soft: #7c8aa5;
            --accent-soft-2: #5f6b82;
        }
        * { box-sizing: border-box; }
        html, body { margin: 0; padding: 0; background: var(--bg); color: var(--text); }
        body { font-family: 'Manrope', sans-serif; height: 100vh; overflow: hidden; }

        body::before {
            content: "";
            position: fixed;
            inset: 0;
            pointer-events: none;
            opacity: .35;
            z-index: 0;
            background-image:
                linear-gradient(to right, rgba(255,255,255,.03) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(255,255,255,.03) 1px, transparent 1px);
            background-size: 32px 32px;
        }

        .app { position: relative; z-index: 1; display: grid; grid-template-columns: 280px 1fr; height: 100vh; }
        .sidebar { background: var(--panel); border-right: 1px solid var(--line); display: flex; flex-direction: column; }

        .brand {
            height: 80px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 0 24px;
            border-bottom: 1px solid var(--line);
            font-weight: 800;
            letter-spacing: -.02em;
        }

        .brand-icon {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            border: 1px solid rgba(245,158,11,.7);
            background: rgba(245,158,11,.08);
            display: grid;
            place-items: center;
            color: #fbbf24;
            font-size: .95rem;
        }

        .brand small { display: block; color: #71717a; font-size: .62rem; letter-spacing: .16em; text-transform: uppercase; }

        .nav { padding: 18px 14px; overflow-y: auto; display: grid; gap: 6px; }
        .nav-item {
            display: flex; align-items: center; gap: 10px;
            border: 1px solid transparent; border-left: 2px solid transparent;
            background: transparent; color: var(--muted); border-radius: 3px;
            padding: 10px 12px; text-align: left; cursor: pointer; font-weight: 600;
            transition: all .2s ease;
        }
        .nav-item .ico { width: 18px; height: 18px; color: #71717a; }
        .nav-item.active { border-left-color: var(--amber); background: rgba(245,158,11,.08); color: #fff; }
        .nav-item.active .ico { color: #f59e0b; }
        .nav-item:hover { color: #fff; background: rgba(255,255,255,.03); border-left-color: rgba(255,255,255,.35); }

        .main { min-width: 0; height: 100vh; overflow-y: auto; }
        .topbar {
            height: 80px;
            border-bottom: 1px solid var(--line);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            background: rgba(5,5,5,.88);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .top-actions { display: flex; align-items: center; gap: 8px; }
        .pill {
            border: 1px solid var(--line);
            background: var(--panel);
            color: #a1a1aa;
            border-radius: 3px;
            padding: 6px 10px;
            display: inline-flex;
            align-items: center;
            gap: 7px;
            font-size: .74rem;
            letter-spacing: .08em;
            text-transform: uppercase;
            cursor: pointer;
        }
        .pill:hover { color: #fff; border-color: rgba(245,158,11,.7); }
        .pill svg { width: 14px; height: 14px; }

        .user { display: flex; align-items: center; gap: 10px; border-left: 1px solid var(--line); padding-left: 12px; }
        .user-avatar { width: 34px; height: 34px; border-radius: 4px; border: 1px solid var(--line); object-fit: cover; background: #151518; }
        .user-name { font-size: .9rem; font-weight: 700; }

        .page { max-width: 1600px; margin: 0 auto; padding: 24px; }
        .header { display: grid; grid-template-columns: 1fr minmax(260px, 320px); gap: 18px; margin-bottom: 20px; align-items: end; }
        .kicker { color: #fbbf24; font-size: .7rem; text-transform: uppercase; letter-spacing: .16em; font-weight: 700; display: inline-flex; gap: 8px; align-items: center; }
        .kicker::before { content: ""; width: 8px; height: 8px; background: var(--amber); }
        h1 { margin: 8px 0 6px; font-size: clamp(1.9rem, 3.8vw, 2.7rem); letter-spacing: -.02em; }
        .subtitle { margin: 0; color: var(--muted); }

        .select { width: 100%; border: 1px solid var(--line); background: var(--panel); color: #ddd; border-radius: 3px; padding: 11px 12px; }
        .select:focus, .input:focus, .textarea:focus { outline: none; border-color: rgba(245,158,11,.7); }

        .tabs { display: none; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }
        .tab-pane { position: relative; }
        .tab-pane:not(#overview) {
            padding-top: 8px;
            border-top: 1px solid rgba(124,138,165,.22);
        }

        .pane-decoration {
            width: 100%;
            height: 56px;
            margin: 0 0 12px;
            border: 1px solid rgba(124,138,165,.20);
            border-radius: 4px;
            background: linear-gradient(180deg, rgba(124,138,165,.10), rgba(124,138,165,0));
            opacity: .95;
            pointer-events: none;
            overflow: hidden;
        }
        .pane-decoration svg { width: 100%; height: 100%; }
        .pane-decoration .p1,
        .pane-decoration .p2,
        .pane-decoration .p3 {
            fill: none;
            stroke: rgba(124,138,165,.75);
            stroke-width: 1.6;
            stroke-linecap: round;
            stroke-dasharray: 12 10;
            animation: dashMove 8s linear infinite;
        }
        .pane-decoration .p2 { stroke: rgba(95,107,130,.62); animation-duration: 10s; }
        .pane-decoration .p3 { stroke: rgba(255,255,255,.16); animation-duration: 12s; }
        @keyframes dashMove {
            from { stroke-dashoffset: 0; transform: translateY(0); }
            50% { transform: translateY(1.5px); }
            to { stroke-dashoffset: -120; transform: translateY(0); }
        }

        .stats { display: grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 12px; margin-bottom: 14px; }
        .card {
            background: var(--panel);
            border: 1px solid var(--line);
            border-radius: 4px;
            padding: 14px;
            position: relative;
        }
        .tab-pane:not(#overview) .card {
            background:
                linear-gradient(160deg, rgba(124,138,165,.08), rgba(124,138,165,0) 46%),
                linear-gradient(0deg, rgba(255,255,255,.01), rgba(255,255,255,.01)),
                var(--panel);
        }
        .card::before {
            content: "";
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(245,158,11,.7), transparent);
            opacity: 0;
            transition: opacity .2s ease;
        }
        .card:hover::before { opacity: 1; }

        .stat-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
        .stat-label { color: #9ca3af; font-size: .64rem; letter-spacing: .12em; text-transform: uppercase; font-weight: 700; }
        .dot { width: 8px; height: 8px; border-radius: 2px; background: var(--amber); }
        .stat-value { font-size: clamp(1.2rem, 2.6vw, 2rem); font-weight: 800; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

        .grid2 { display: grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 12px; }
        .chart-head { display: flex; justify-content: space-between; align-items: center; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
        .chart-title { margin: 0; font-size: .8rem; text-transform: uppercase; letter-spacing: .12em; }
        .chip {
            border: 1px solid var(--line); background: transparent; color: #a1a1aa;
            border-radius: 3px; padding: 5px 8px; font-size: .64rem; text-transform: uppercase; letter-spacing: .12em; cursor: pointer;
        }
        .chip.active, .chip:hover { color: #fff; border-color: rgba(245,158,11,.7); background: rgba(245,158,11,.08); }

        .chart-wrap { height: 250px; border: 1px dashed rgba(255,255,255,.12); border-radius: 3px; padding: 8px; background: rgba(255,255,255,.01); }

        .section-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .section-title { margin: 0 0 10px; font-size: .9rem; text-transform: uppercase; letter-spacing: .1em; color: #f4f4f5; }
        .row { margin-bottom: 10px; }
        .label { display: block; color: #9ca3af; font-size: .74rem; margin-bottom: 6px; }
        .input, .textarea, .form-select {
            width: 100%;
            border: 1px solid var(--line);
            background: #0c0c0d;
            color: #ddd;
            border-radius: 3px;
            padding: 10px;
            font-family: inherit;
        }
        .textarea { min-height: 96px; resize: vertical; }

        .actions { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
        .btn {
            border: 1px solid var(--line);
            background: var(--panel);
            color: #e5e7eb;
            border-radius: 3px;
            padding: 8px 12px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: .8rem;
            letter-spacing: .04em;
            text-transform: uppercase;
        }
        .btn:hover { border-color: rgba(245,158,11,.65); background: rgba(245,158,11,.08); color: #fff; }
        .tab-pane:not(#overview) .btn {
            background: linear-gradient(120deg, rgba(124,138,165,.12), rgba(124,138,165,.03));
        }
        .tab-pane:not(#overview) .btn:hover {
            border-color: rgba(124,138,165,.75);
            background: linear-gradient(120deg, rgba(124,138,165,.20), rgba(124,138,165,.06));
        }

        .rules-preview {
            border: 1px dashed rgba(245,158,11,.45);
            border-radius: 4px;
            padding: 12px;
            color: #d4d4d8;
            background: rgba(255,255,255,.01);
        }

        .table-wrap { overflow: auto; border: 1px solid var(--line); border-radius: 3px; }
        table { width: 100%; border-collapse: collapse; min-width: 760px; }
        th, td { padding: 10px; border-bottom: 1px solid rgba(255,255,255,.06); font-size: .83rem; text-align: left; }
        th { color: #e5e7eb; background: rgba(255,255,255,.02); text-transform: uppercase; letter-spacing: .08em; font-size: .68rem; }
        td { color: #d4d4d8; }

        .loading { position: fixed; inset: 0; z-index: 30; display: grid; place-items: center; background: rgba(4,4,4,.86); backdrop-filter: blur(2px); }
        .spinner { width: 42px; height: 42px; border-radius: 50%; border: 3px solid rgba(255,255,255,.12); border-top-color: var(--amber); animation: spin 1s linear infinite; margin: 0 auto 12px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .banner { display:none; margin-bottom: 12px; border: 1px solid rgba(239,68,68,.5); background: rgba(239,68,68,.08); border-radius: 3px; padding: 10px 12px; color: #fca5a5; font-size: .85rem; }

        @media (max-width: 1200px) { .stats { grid-template-columns: repeat(2, minmax(0,1fr)); } }
        @media (max-width: 980px) {
            body { overflow: auto; }
            .app { grid-template-columns: 1fr; height: auto; }
            .sidebar { display: none; }
            .main { height: auto; }
            .header { grid-template-columns: 1fr; }
            .grid2, .section-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="loadingOverlay" class="loading">
        <div><div class="spinner"></div><div style="color:#a1a1aa; text-transform:uppercase; letter-spacing:.12em; font-size:.78rem;">Chargement du dashboard...</div></div>
    </div>

    <div class="app" id="dashboardContent" style="display:none;">
        <aside class="sidebar">
            <div class="brand">
                <span class="brand-icon">üêù</span>
                <span>Maybee <small>Tableau de bord</small></span>
            </div>
            <nav class="nav">
                <button class="nav-item active" data-tab="overview"><svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>Vue d'ensemble</button>
                <button class="nav-item" data-tab="xp-settings"><svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 21h8"/><path d="M12 17v4"/><path d="M7 4h10l-1 7H8L7 4z"/></svg>Syst√®me XP</button>
                <button class="nav-item" data-tab="moderation"><svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3l8 4v5c0 5-3.5 8.5-8 9-4.5-.5-8-4-8-9V7l8-4z"/></svg>Mod√©ration</button>
                <button class="nav-item" data-tab="welcome"><svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 11V5a4 4 0 0 0-8 0v6"/><rect x="4" y="11" width="16" height="10" rx="2"/></svg>Bienvenue</button>
                <button class="nav-item" data-tab="role-menus"><svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>Menus de r√¥les</button>
                <button class="nav-item" data-tab="logs"><svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16l4-3 4 3 4-3 4 3V8z"/><path d="M14 2v6h6"/></svg>Logs serveur</button>
                <button class="nav-item" data-tab="tickets"><svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9h18v6H3z"/><path d="M7 9V5h10v4"/></svg>Tickets</button>
                <button class="nav-item" data-tab="rules"><svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>R√®glement</button>
                <button class="nav-item" data-tab="ticket-logs"><svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 3 3 9 9 9"/><path d="M3.05 13a9 9 0 1 0 .5-5"/></svg>Historique tickets</button>
                <button class="nav-item" data-tab="embed"><svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>Messages embed</button>
            </nav>
        </aside>

        <main class="main">
            <header class="topbar">
                <div class="top-actions">
                    <button class="pill" id="logoutBtn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>D√©connexion</button>
                </div>
                <div class="user">
                    <img id="userAvatar" class="user-avatar" alt="Avatar" src="" style="display:none;">
                    <div class="user-name" id="username">chargement...</div>
                </div>
            </header>

            <section class="page">
                <div id="errorBanner" class="banner"></div>

                <section class="tab-pane active" id="overview">
                    <div class="header">
                        <div>
                            <span class="kicker">Syst√®me actif</span>
                            <h1>Vue d'ensemble du tableau de bord</h1>
                            <p class="subtitle">T√©l√©m√©trie et m√©triques principales de votre infrastructure Discord.</p>
                        </div>
                        <div>
                            <label style="display:block; color:#71717a; font-size:.62rem; text-transform:uppercase; letter-spacing:.16em; margin-bottom:6px; font-weight:700;">Serveur cible</label>
                            <select id="guildSelector" class="select"><option value="">S√©lectionner un serveur...</option></select>
                        </div>
                    </div>

                    <div class="stats">
                        <article class="card"><div class="stat-top"><span class="stat-label">Membres totaux</span><span class="dot"></span></div><div class="stat-value" id="totalMembers">0</div></article>
                        <article class="card"><div class="stat-top"><span class="stat-label">XP total</span><span class="dot"></span></div><div class="stat-value" id="totalXP">0</div></article>
                        <article class="card"><div class="stat-top"><span class="stat-label">Niveau moyen</span><span class="dot"></span></div><div class="stat-value" id="avgLevel">0</div></article>
                        <article class="card"><div class="stat-top"><span class="stat-label">Activit√© r√©cente</span><span class="dot"></span></div><div class="stat-value" id="recentActivity">0</div></article>
                    </div>

                    <div class="grid2">
                        <article class="card">
                            <div class="chart-head"><h3 class="chart-title">Croissance des membres</h3><div><button class="chip active" data-period="30d" data-chart="memberGrowth">30j</button> <button class="chip" data-period="90d" data-chart="memberGrowth">90j</button></div></div>
                            <div class="chart-wrap"><canvas id="memberGrowthChart"></canvas></div>
                        </article>
                        <article class="card">
                            <div class="chart-head"><h3 class="chart-title">Aper√ßu de l'activit√©</h3><div><button class="chip active" data-period="7d" data-chart="activity">7j</button> <button class="chip" data-period="30d" data-chart="activity">30j</button></div></div>
                            <div class="chart-wrap"><canvas id="activityChart"></canvas></div>
                        </article>
                        <article class="card">
                            <div class="chart-head"><h3 class="chart-title">Distribution de l'XP</h3><div><button class="chip" id="refreshXpDistribution">Actualiser</button></div></div>
                            <div class="chart-wrap"><canvas id="xpDistributionChart"></canvas></div>
                        </article>
                        <article class="card">
                            <div class="chart-head"><h3 class="chart-title">√âvolution de l'XP</h3><div><button class="chip active" data-period="30d" data-chart="xpEvolution">30j</button> <button class="chip" data-period="90d" data-chart="xpEvolution">90j</button></div></div>
                            <div class="chart-wrap"><canvas id="xpEvolutionChart"></canvas></div>
                        </article>
                    </div>
                </section>

                <section class="tab-pane" id="xp-settings">
                    <article class="card">
                        <h3 class="section-title">Syst√®me XP</h3>
                        <div class="section-grid">
                            <div>
                                <div class="row"><label class="label">Activer l'XP</label><input type="checkbox" id="xpEnabled" checked></div>
                                <div class="row"><label class="label">Salon XP</label><select id="xpChannel" class="form-select"><option value="">Tous les salons</option></select></div>
                                <div class="row"><label class="label">Multiplicateur</label><input class="input" id="xpMultiplier" type="number" step="0.1" min="0.1" value="1.0"></div>
                            </div>
                            <div>
                                <div class="row"><label class="label">Messages de niveau</label><input type="checkbox" id="levelUpMessage" checked></div>
                                <div class="row"><label class="label">Salon de niveau</label><select id="levelUpChannel" class="form-select"><option value="">Salon actuel</option></select></div>
                                <div class="row"><label class="label">Texte d'aper√ßu niveau</label><textarea id="levelUpSimpleMessage" class="textarea" placeholder="Bravo {user} ! Tu as atteint le niveau {level} !"></textarea></div>
                            </div>
                        </div>
                        <div class="actions"><button class="btn" id="saveXpSettingsBtn">Sauvegarder XP</button><button class="btn" id="testLevelUpBtn">Tester niveau</button></div>
                    </article>
                </section>

                <section class="tab-pane" id="moderation">
                    <article class="card" style="margin-bottom:12px;">
                        <h3 class="section-title">Actions de mod√©ration</h3>
                        <div class="section-grid">
                            <div>
                                <div class="row"><label class="label">Membre</label><select id="memberSelect" class="form-select"><option value="">S√©lectionner un membre...</option></select></div>
                                <div class="row"><label class="label">Action</label><select id="moderationAction" class="form-select"><option value="">S√©lectionner une action...</option><option value="warn">Avertir</option><option value="timeout">Temporiser</option><option value="kick">Expulser</option><option value="ban">Bannir</option></select></div>
                                <div class="row" id="timeoutDuration"><label class="label">Dur√©e timeout (minutes)</label><input id="timeoutMinutes" class="input" type="number" min="1" max="10080" value="60"></div>
                            </div>
                            <div>
                                <div class="row"><label class="label">Raison</label><textarea id="moderationReason" class="textarea"></textarea></div>
                                <div class="row"><label class="label">Salon de log</label><select id="moderationChannel" class="form-select"><option value="">Aucune notification</option></select></div>
                            </div>
                        </div>
                        <div class="actions"><button class="btn" id="executeModerationBtn">Ex√©cuter l'action</button></div>
                    </article>
                    <article class="card">
                        <h3 class="section-title">Historique de mod√©ration</h3>
                        <div class="table-wrap"><table><thead><tr><th>Utilisateur</th><th>Action</th><th>Mod√©rateur</th><th>Raison</th><th>Date</th><th>Dur√©e</th></tr></thead><tbody id="moderationHistoryTable"><tr><td colspan="6">Aucune donn√©e</td></tr></tbody></table></div>
                    </article>
                </section>

                <section class="tab-pane" id="welcome">
                    <article class="card">
                        <h3 class="section-title">Syst√®me de bienvenue</h3>
                        <div class="section-grid">
                            <div>
                                <div class="row"><label class="label">Activer la bienvenue</label><input type="checkbox" id="welcomeEnabled"></div>
                                <div class="row"><label class="label">Salon de bienvenue</label><select id="welcomeChannel" class="form-select"><option value="">S√©lectionner un salon...</option></select></div>
                                <div class="row"><label class="label">Titre de bienvenue</label><input id="welcomeTitle" class="input" type="text"></div>
                                <div class="row"><label class="label">Message de bienvenue</label><textarea id="welcomeMessage" class="textarea" placeholder="Bienvenue {user} sur {server} !"></textarea></div>
                            </div>
                            <div>
                                <div class="row"><label class="label">Activer l'au revoir</label><input type="checkbox" id="goodbyeEnabled"></div>
                                <div class="row"><label class="label">Salon d'au revoir</label><select id="goodbyeChannel" class="form-select"><option value="">S√©lectionner un salon...</option></select></div>
                                <div class="row"><label class="label">Titre d'au revoir</label><input id="goodbyeTitle" class="input" type="text"></div>
                                <div class="row"><label class="label">Message d'au revoir</label><textarea id="goodbyeMessage" class="textarea" placeholder="Au revoir {user} !"></textarea></div>
                            </div>
                        </div>
                        <div class="actions"><button class="btn" id="saveWelcomeBtn">Sauvegarder bienvenue</button><button class="btn" id="testWelcomeBtn">Tester bienvenue</button></div>
                    </article>
                </section>

                <section class="tab-pane" id="role-menus">
                    <article class="card">
                        <h3 class="section-title">Menus de r√¥les</h3>
                        <div class="actions"><button class="btn" id="refreshRoleMenusBtn">Actualiser</button><button class="btn" id="createRoleMenuBtn">Cr√©er un menu</button></div>
                        <div id="roleMenusList" style="margin-top:10px; color:#a1a1aa;">Aucun menu de r√¥les charg√©.</div>
                    </article>

                    <article class="card" id="roleMenuEditorCard" style="display:none; margin-top:12px;">
                        <h3 class="section-title" id="roleMenuEditorTitle">Cr√©er un menu de r√¥les</h3>
                        <div class="section-grid">
                            <div>
                                <div class="row"><label class="label">Titre du menu</label><input id="menuTitle" class="input" type="text" maxlength="256"></div>
                                <div class="row"><label class="label">Salon</label><select id="menuChannel" class="form-select"><option value="">S√©lectionner un salon...</option></select></div>
                                <div class="row"><label class="label">Description</label><textarea id="menuDescription" class="textarea" rows="3"></textarea></div>
                            </div>
                            <div>
                                <div class="row"><label class="label">Couleur</label><input id="menuColor" class="input" type="text" value="#5865F2" placeholder="#5865F2"></div>
                                <div class="row"><label class="label">Texte indicatif</label><input id="menuPlaceholder" class="input" type="text" value="S√©lectionner un r√¥le..." maxlength="150"></div>
                                <div class="row"><label class="label">Mode de s√©lection</label><select id="selectionMode" class="form-select"><option value="single">Unique</option><option value="multiple">Multiple</option></select></div>
                                <div class="row" id="maxValuesGroup" style="display:none;"><label class="label">S√©lections max</label><input id="maxValues" class="input" type="number" min="1" max="25" value="5"></div>
                            </div>
                        </div>
                        <div class="row">
                            <label class="label">Options de r√¥le</label>
                            <div id="roleOptionsList"></div>
                            <div class="actions"><button class="btn" id="addRoleOptionBtn" type="button">Ajouter une option</button></div>
                        </div>
                        <div class="actions"><button class="btn" id="saveRoleMenuBtn">Sauvegarder</button><button class="btn" id="cancelRoleMenuBtn">Annuler</button></div>
                    </article>
                </section>

                <section class="tab-pane" id="logs">
                    <article class="card">
                        <h3 class="section-title">Logs serveur</h3>
                        <div class="section-grid">
                            <div>
                                <div class="row"><label class="label">Activer les logs</label><input type="checkbox" id="serverLogsEnabled"></div>
                                <div class="row"><label class="label">Salon des logs</label><select id="serverLogsChannel" class="form-select"><option value="">S√©lectionner un salon...</option></select></div>
                            </div>
                            <div>
                                <div class="row"><label class="label">√âv√©nements</label>
                                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; color:#c4c4cc; font-size:.82rem;">
                                        <label><input type="checkbox" id="logMessageDelete"> Suppression message</label>
                                        <label><input type="checkbox" id="logMessageEdit"> √âdition message</label>
                                        <label><input type="checkbox" id="logMemberJoin"> Arriv√©e membre</label>
                                        <label><input type="checkbox" id="logMemberLeave"> D√©part membre</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="actions"><button class="btn" id="saveLogSettingsBtn">Sauvegarder les logs</button></div>
                    </article>
                </section>

                <section class="tab-pane" id="tickets">
                    <article class="card">
                        <h3 class="section-title">Syst√®me de tickets</h3>
                        <div class="row"><label class="label">Activer le syst√®me de tickets</label><input type="checkbox" id="ticketSystemEnabled"></div>
                        <div class="actions"><button class="btn" id="createTicketPanelBtn">Cr√©er un panel</button></div>
                        <div id="ticketPanelsList" style="margin-top:10px; color:#a1a1aa;">Aucun panel pour le moment.</div>
                    </article>

                    <article class="card" id="ticketPanelEditorCard" style="display:none; margin-top:12px;">
                        <h3 class="section-title" id="ticketPanelEditorTitle">Cr√©er un panel ticket</h3>
                        <div class="section-grid">
                            <div>
                                <div class="row"><label class="label">Nom du panel</label><input id="ticketPanelName" class="input" type="text"></div>
                                <div class="row"><label class="label">Titre embed</label><input id="ticketEmbedTitle" class="input" type="text" value="üé´ Tickets Support"></div>
                                <div class="row"><label class="label">Description embed</label><textarea id="ticketEmbedDescription" class="textarea" rows="3">Clique sur un bouton ci-dessous pour cr√©er un ticket support</textarea></div>
                                <div class="row"><label class="label">Couleur embed</label><input id="ticketEmbedColor" class="input" type="color" value="#5865F2"></div>
                            </div>
                            <div>
                                <div class="row"><label class="label">URL miniature</label><input id="ticketEmbedThumbnail" class="input" type="url"></div>
                                <div class="row"><label class="label">URL image</label><input id="ticketEmbedImage" class="input" type="url"></div>
                                <div class="row"><label class="label">Texte de pied de page</label><input id="ticketEmbedFooter" class="input" type="text"></div>
                            </div>
                        </div>

                        <div class="row" style="margin-top:12px;">
                            <label class="label">Boutons de ticket</label>
                            <div id="ticketButtonsList"></div>
                            <div class="actions"><button class="btn" id="addTicketButtonBtn" type="button">Ajouter un bouton</button></div>
                        </div>

                        <div class="row" style="margin-top:12px;">
                            <label class="label"><input type="checkbox" id="panelVerification"> Activer le workflow de v√©rification sur ce panel</label>
                        </div>
                        <div id="verificationOptionsContainer" style="display:none;">
                            <div class="section-grid">
                                <div>
                                    <div class="row"><label class="label">R√¥le v√©rificateur</label><select id="verifierRole" class="form-select"><option value="">Aucun</option></select></div>
                                    <div class="row"><label class="label">R√¥les √† retirer</label><select id="rolesToRemove" class="form-select" multiple></select></div>
                                </div>
                                <div>
                                    <div class="row"><label class="label">R√¥les √† ajouter</label><select id="rolesToAdd" class="form-select" multiple></select></div>
                                    <div class="row"><label class="label">Salon de v√©rification</label><select id="verificationChannel" class="form-select"><option value="">S√©lectionner un salon...</option></select></div>
                                </div>
                            </div>
                            <div class="row"><label class="label">Message de v√©rification</label><textarea id="verificationMessage" class="textarea" rows="2"></textarea></div>
                            <div class="row"><label class="label">URL image de v√©rification</label><input id="verificationImageUrl" class="input" type="url"></div>
                        </div>

                        <div class="actions"><button class="btn" id="saveTicketPanelBtn">Sauvegarder panel</button><button class="btn" id="cancelTicketPanelBtn">Annuler</button></div>
                    </article>
                </section>

                <section class="tab-pane" id="rules">
                    <article class="card" style="margin-bottom:12px;">
                        <h3 class="section-title">R√®glement ‚Ä¢ Publication</h3>
                        <div class="section-grid">
                            <div>
                                <div class="row"><label class="label">Salon du r√®glement</label><select id="rulesChannel" class="form-select"><option value="">S√©lectionner un salon...</option></select></div>
                                <div class="row"><label class="label">Titre</label><input id="rulesTitle" class="input" type="text"></div>
                                <div class="row"><label class="label">Description</label><textarea id="rulesDescription" class="textarea" rows="5"></textarea></div>
                                <div class="row"><label class="label">Couleur</label><input id="rulesColor" class="input" type="color" value="#5865F2"></div>
                            </div>
                            <div>
                                <div class="row"><label class="label">URL miniature</label><input id="rulesThumbnail" class="input" type="url"></div>
                                <div class="row"><label class="label">URL image</label><input id="rulesImage" class="input" type="url"></div>
                                <div class="row"><label class="label">Footer</label><input id="rulesFooter" class="input" type="text"></div>
                                <div class="row"><label class="label">Bouton label</label><input id="rulesButtonLabel" class="input" type="text" value="J'accepte"></div>
                                <div class="row section-grid" style="grid-template-columns: 1fr 1fr; gap:8px;"><div><label class="label">Emoji</label><input id="rulesButtonEmoji" class="input" type="text" value="‚úÖ"></div><div><label class="label">Style</label><select id="rulesButtonStyle" class="form-select"><option value="primary">Principal</option><option value="secondary">Secondaire</option><option value="success">Succ√®s</option><option value="danger">Danger</option></select></div></div>
                            </div>
                        </div>
                        <div class="row" style="margin-top:8px;">
                            <label class="label">Champs du r√®glement (optionnel)</label>
                            <div id="rulesFieldsList"></div>
                            <div class="actions"><button class="btn" id="addRulesFieldBtn" type="button">Ajouter un champ</button></div>
                        </div>
                    </article>

                    <article class="card" style="margin-bottom:12px;">
                        <h3 class="section-title">R√®glement ‚Ä¢ Validation</h3>
                        <div class="section-grid">
                            <div>
                                <div class="row"><label class="label">R√¥le √† donner apr√®s validation</label><select id="rulesGrantRole" class="form-select"><option value="">Aucun</option></select></div>
                                <div class="row"><label class="label">Activer message de bienvenue</label><input type="checkbox" id="rulesWelcomeEnabled" checked></div>
                                <div class="row"><label class="label">Salon du message de bienvenue</label><select id="rulesWelcomeChannel" class="form-select"><option value="">S√©lectionner un salon...</option></select></div>
                            </div>
                            <div class="rules-preview">
                                Variables utilisables : <strong>{user}</strong>, <strong>{username}</strong>, <strong>{server}</strong>, <strong>{avatar}</strong>
                            </div>
                        </div>
                    </article>

                    <article class="card">
                        <h3 class="section-title">Embed de bienvenue (personnalisable)</h3>
                        <div class="section-grid">
                            <div>
                                <div class="row"><label class="label">Titre</label><input id="rulesWelcomeTitle" class="input" type="text" value="Bienvenue {username} !"></div>
                                <div class="row"><label class="label">Description</label><textarea id="rulesWelcomeDescription" class="textarea" rows="4">{user} vient de valider le r√®glement.</textarea></div>
                                <div class="row"><label class="label">Couleur</label><input id="rulesWelcomeColor" class="input" type="color" value="#5865F2"></div>
                            </div>
                            <div>
                                <div class="row"><label class="label">URL miniature (par d√©faut : {avatar})</label><input id="rulesWelcomeThumbnail" class="input" type="text" value="{avatar}"></div>
                                <div class="row"><label class="label">URL image</label><input id="rulesWelcomeImage" class="input" type="url"></div>
                                <div class="row"><label class="label">Footer</label><input id="rulesWelcomeFooter" class="input" type="text" value="Profite bien de ton arriv√©e !"></div>
                            </div>
                        </div>
                        <div class="actions"><button class="btn" id="saveRulesBtn">Sauvegarder</button><button class="btn" id="deployRulesBtn">Publier le r√®glement</button></div>
                    </article>
                </section>

                <section class="tab-pane" id="ticket-logs">
                    <article class="card">
                        <h3 class="section-title">Historique des tickets</h3>
                        <div class="section-grid">
                            <div>
                                <div class="row"><label class="label">Rechercher un utilisateur</label><input id="ticketSearchInput" class="input" type="text" placeholder="Nom d'utilisateur ou ID"></div>
                                <div class="actions"><button class="btn" id="searchTicketLogsBtn">Rechercher</button></div>
                            </div>
                            <div>
                                <div id="ticketSearchResults" style="color:#a1a1aa;">Aucune recherche lanc√©e.</div>
                            </div>
                        </div>
                    </article>
                </section>

                <section class="tab-pane" id="embed">
                    <article class="card">
                        <h3 class="section-title">Cr√©ateur d'embed</h3>
                        <div class="section-grid">
                            <div>
                                <div class="row"><label class="label">Salon cible</label><select id="embedTargetChannel" class="form-select"><option value="">S√©lectionner un salon...</option></select></div>
                                <div class="row"><label class="label">Titre</label><input id="embedTitle" class="input" type="text"></div>
                                <div class="row"><label class="label">Description</label><textarea id="embedDescription" class="textarea"></textarea></div>
                            </div>
                            <div>
                                <div class="row"><label class="label">Couleur</label><input id="embedColor" class="input" type="color" value="#5865F2"></div>
                                <div class="row"><label class="label">URL image</label><input id="embedImage" class="input" type="url"></div>
                                <div class="row"><label class="label">URL miniature</label><input id="embedThumbnail" class="input" type="url"></div>
                            </div>
                        </div>
                        <div class="actions"><button class="btn" id="sendEmbedBtn">Envoyer l'embed</button><button class="btn" id="previewEmbedBtn">Aper√ßu</button></div>
                    </article>
                </section>
            </section>
        </main>
    </div>

    <script>
        (function () {
            const charts = { memberGrowth: null, activity: null, xpDistribution: null, xpEvolution: null };
            const state = {
                guildId: null,
                user: null,
                channels: [],
                roles: [],
                categories: [],
                members: [],
                roleMenus: [],
                ticketPanels: [],
                rulesConfig: null,
                editingRoleMenuId: null,
                editingTicketPanelId: null,
                memberGrowthPeriod: '30d',
                activityPeriod: '7d',
                xpEvolutionPeriod: '30d'
            };

            const el = (id) => document.getElementById(id);

            function getCookie(name) {
                const value = `; ${document.cookie}`;
                const parts = value.split(`; ${name}=`);
                if (parts.length === 2) return parts.pop().split(';').shift();
                return null;
            }

            async function apiCall(path, method = 'GET', body = null) {
                const token = getCookie('access_token');
                const options = {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        ...(token ? { Authorization: `Bearer ${token}` } : {})
                    }
                };
                if (body) options.body = JSON.stringify(body);
                const res = await fetch(`/api${path}`, options);
                if (res.status === 401) {
                    window.location.href = '/';
                    throw new Error('Unauthorized');
                }
                if (!res.ok) {
                    let detail = `API error: ${res.status}`;
                    try {
                        const data = await res.json();
                        detail = data.detail || data.message || detail;
                    } catch (_) {}
                    throw new Error(detail);
                }
                return res.json();
            }

            function showBanner(message, isError = true) {
                const banner = el('errorBanner');
                if (!banner) return;
                banner.style.display = 'block';
                banner.style.borderColor = isError ? 'rgba(239,68,68,.5)' : 'rgba(16,185,129,.5)';
                banner.style.background = isError ? 'rgba(239,68,68,.08)' : 'rgba(16,185,129,.08)';
                banner.style.color = isError ? '#fca5a5' : '#86efac';
                banner.textContent = message;
            }
            function hideBanner() {
                const banner = el('errorBanner');
                if (!banner) return;
                banner.style.display = 'none';
                banner.textContent = '';
            }
            function setLoading(isLoading) {
                el('loadingOverlay').style.display = isLoading ? 'grid' : 'none';
                el('dashboardContent').style.display = isLoading ? 'none' : 'grid';
            }

            function activateTab(tabId) {
                document.querySelectorAll('.nav-item').forEach(item => item.classList.toggle('active', item.dataset.tab === tabId));
                document.querySelectorAll('.tab-pane').forEach(tab => tab.classList.toggle('active', tab.id === tabId));
                loadTabData(tabId).catch((e) => showBanner(e.message));
            }

            document.querySelectorAll('.nav-item[data-tab]').forEach(item => {
                item.addEventListener('click', () => activateTab(item.dataset.tab));
            });

            function numberFormat(value) {
                return (value === null || value === undefined) ? '0' : Number(value).toLocaleString();
            }
            function updateStats(stats) {
                el('totalMembers').textContent = numberFormat(stats.total_members);
                el('totalXP').textContent = numberFormat(stats.total_xp);
                el('avgLevel').textContent = stats.average_level ?? '0';
                el('recentActivity').textContent = numberFormat(stats.recent_activity);
            }

            function emptyChart(canvasId, label = 'No data yet') {
                const ctx = el(canvasId).getContext('2d');
                return new Chart(ctx, {
                    type: 'line',
                    data: { labels: [], datasets: [] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false }, title: { display: true, text: label, color: '#71717a' } },
                        scales: { x: { display: false }, y: { display: false } }
                    }
                });
            }
            function destroyChart(name) { if (charts[name]) { charts[name].destroy(); charts[name] = null; } }
            function commonChartOptions() {
                return {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#d4d4d8' } } },
                    scales: {
                        x: { ticks: { color: '#a1a1aa' }, grid: { color: 'rgba(255,255,255,.08)' } },
                        y: { ticks: { color: '#a1a1aa' }, grid: { color: 'rgba(255,255,255,.08)' } }
                    }
                };
            }

            function populateSelect(selectId, items, valueKey = 'id', textKey = 'name', emptyLabel = null) {
                const select = el(selectId);
                if (!select) return;
                const previous = select.value;
                const options = [];
                if (emptyLabel !== null) options.push(`<option value="">${emptyLabel}</option>`);
                items.forEach(item => options.push(`<option value="${item[valueKey]}">${item[textKey]}</option>`));
                select.innerHTML = options.join('');
                if (previous && select.querySelector(`option[value="${previous}"]`)) select.value = previous;
            }

            async function loadGuildResources() {
                if (!state.guildId) return;
                const [channelsResp, rolesResp, membersResp, categoriesResp] = await Promise.all([
                    apiCall(`/guild/${state.guildId}/channels`),
                    apiCall(`/guild/${state.guildId}/roles`),
                    apiCall(`/guild/${state.guildId}/members`),
                    apiCall(`/guild/${state.guildId}/categories`)
                ]);

                const normalizeList = (resp, key) => {
                    if (Array.isArray(resp)) return resp;
                    if (resp && Array.isArray(resp[key])) return resp[key];
                    return [];
                };

                state.channels = normalizeList(channelsResp, 'channels').map(channel => ({
                    id: String(channel.id),
                    name: channel.name || `channel-${channel.id}`,
                    type: channel.type
                }));

                state.roles = normalizeList(rolesResp, 'roles').map(role => ({
                    id: String(role.id),
                    name: role.name || `role-${role.id}`
                }));

                state.members = normalizeList(membersResp, 'members').map(member => ({
                    id: String(member.id),
                    display_name: member.display_name || member.username || `user-${member.id}`,
                    username: member.username || member.display_name || `user-${member.id}`
                }));

                state.categories = normalizeList(categoriesResp, 'categories').map(category => ({
                    id: String(category.id),
                    name: category.name || `category-${category.id}`
                }));

                const channelTargets = ['xpChannel', 'levelUpChannel', 'welcomeChannel', 'goodbyeChannel', 'serverLogsChannel', 'moderationChannel', 'embedTargetChannel', 'rulesChannel', 'rulesWelcomeChannel'];
                channelTargets.forEach(id => populateSelect(id, state.channels, 'id', 'name', 'S√©lectionner un salon...'));
                populateSelect('memberSelect', state.members, 'id', 'display_name', 'S√©lectionner un membre...');
                populateSelect('rulesGrantRole', state.roles.filter(r => r.name !== '@everyone'), 'id', 'name', 'Aucun');

                if (!state.channels.length) showBanner('Aucun salon re√ßu pour ce serveur. V√©rifie les permissions/intents du bot.');
            }

            async function loadStats() {
                if (!state.guildId) return;
                const stats = await apiCall(`/guild/${state.guildId}/stats`);
                updateStats(stats || {});
            }
            async function loadMemberGrowthChart() {
                destroyChart('memberGrowth');
                if (!state.guildId) { charts.memberGrowth = emptyChart('memberGrowthChart', 'S√©lectionne un serveur'); return; }
                const data = await apiCall(`/guilds/${state.guildId}/stats/member-growth?period=${state.memberGrowthPeriod}`);
                const ctx = el('memberGrowthChart').getContext('2d');
                charts.memberGrowth = new Chart(ctx, { type: 'line', data: { labels: data.labels || [], datasets: [{ label: 'Membres', data: data.data || [], borderColor: '#F59E0B', backgroundColor: 'rgba(245,158,11,.18)', tension: .35, fill: true, pointRadius: 0 }] }, options: commonChartOptions() });
            }
            async function loadActivityChart() {
                destroyChart('activity');
                if (!state.guildId) { charts.activity = emptyChart('activityChart', 'S√©lectionne un serveur'); return; }
                const data = await apiCall(`/guilds/${state.guildId}/stats/activity?period=${state.activityPeriod}`);
                const ctx = el('activityChart').getContext('2d');
                charts.activity = new Chart(ctx, { type: 'bar', data: { labels: data.labels || [], datasets: [{ label: 'Activit√©', data: data.data || [], borderColor: 'rgba(251,191,36,1)', backgroundColor: 'rgba(251,191,36,.35)', borderWidth: 1 }] }, options: commonChartOptions() });
            }
            async function loadXpDistributionChart() {
                destroyChart('xpDistribution');
                if (!state.guildId) { charts.xpDistribution = emptyChart('xpDistributionChart', 'S√©lectionne un serveur'); return; }
                const data = await apiCall(`/guilds/${state.guildId}/stats/xp-distribution`);
                const ctx = el('xpDistributionChart').getContext('2d');
                charts.xpDistribution = new Chart(ctx, { type: 'doughnut', data: { labels: data.labels || [], datasets: [{ data: data.data || [], backgroundColor: ['#F59E0B', '#FBBF24', '#FCD34D', '#92400E', '#78350F'] }] }, options: { ...commonChartOptions(), scales: undefined } });
            }
            async function loadXpEvolutionChart() {
                destroyChart('xpEvolution');
                if (!state.guildId) { charts.xpEvolution = emptyChart('xpEvolutionChart', 'S√©lectionne un serveur'); return; }
                const data = await apiCall(`/guilds/${state.guildId}/stats/xp-evolution?period=${state.xpEvolutionPeriod}&type=both`);
                const ctx = el('xpEvolutionChart').getContext('2d');
                charts.xpEvolution = new Chart(ctx, { type: 'line', data: { labels: data.labels || [], datasets: [{ label: '√âvolution XP', data: data.data || [], borderColor: '#FBBF24', backgroundColor: 'rgba(251,191,36,.15)', fill: true, tension: .35, pointRadius: 0 }] }, options: commonChartOptions() });
            }
            async function loadOverview() {
                await Promise.all([loadStats(), loadMemberGrowthChart(), loadActivityChart(), loadXpDistributionChart(), loadXpEvolutionChart()]);
            }

            async function loadXpTab() {
                if (!state.guildId) return;
                const [xp, levelup] = await Promise.all([
                    apiCall(`/guild/${state.guildId}/xp`),
                    apiCall(`/guild/${state.guildId}/level-up-config`)
                ]);
                el('xpEnabled').checked = !!xp.enabled;
                el('xpMultiplier').value = xp.multiplier ?? 1.0;
                el('xpChannel').value = xp.xp_channel || '';
                el('levelUpMessage').checked = !!xp.level_up_message;
                el('levelUpChannel').value = xp.level_up_channel || levelup.channel_id || '';
                el('levelUpSimpleMessage').value = levelup.message_content || 'Bravo {user} ! Tu as atteint le niveau {level} !';
            }
            async function saveXpTab() {
                if (!state.guildId) return;
                await apiCall(`/guild/${state.guildId}/xp`, 'PUT', {
                    enabled: el('xpEnabled').checked,
                    xp_channel: el('xpChannel').value || null,
                    level_up_message: el('levelUpMessage').checked,
                    level_up_channel: el('levelUpChannel').value || null,
                    multiplier: Number(el('xpMultiplier').value || 1)
                });
                await apiCall(`/guild/${state.guildId}/level-up-config`, 'PUT', {
                    enabled: true,
                    channel_id: el('levelUpChannel').value || null,
                    message_type: 'simple',
                    message_content: el('levelUpSimpleMessage').value || 'Bravo {user} ! Tu as atteint le niveau {level} !',
                    embed_title: 'Niveau sup√©rieur !',
                    embed_description: '{user} a atteint le niveau **{level}** !',
                    embed_color: '#FFD700',
                    embed_thumbnail_url: null,
                    show_user_avatar: true,
                    embed_image_url: null,
                    embed_footer_text: 'Continue comme √ßa !',
                    embed_timestamp: true
                });
                showBanner('Param√®tres XP sauvegard√©s.', false);
            }

            async function loadModerationTab() {
                if (!state.guildId) return;
                const data = await apiCall(`/guild/${state.guildId}/moderation/history`);
                const rows = data.history || [];
                const body = el('moderationHistoryTable');
                body.innerHTML = rows.length
                    ? rows.map(item => `<tr><td>${item.user_id}</td><td>${item.action_type}</td><td>${item.moderator_id}</td><td>${item.reason || ''}</td><td>${item.created_at || ''}</td><td>${item.duration || '-'}</td></tr>`).join('')
                    : '<tr><td colspan="6">Aucun historique de mod√©ration.</td></tr>';
            }
            async function executeModeration() {
                if (!state.guildId) return;
                const action = el('moderationAction').value;
                const userId = el('memberSelect').value;
                if (!action || !userId) { showBanner('S√©lectionne un membre et une action.'); return; }
                await apiCall(`/guild/${state.guildId}/moderation/action`, 'POST', {
                    action,
                    user_id: userId,
                    reason: el('moderationReason').value || 'Aucune raison fournie',
                    duration: action === 'timeout' ? Number(el('timeoutMinutes').value || 60) : null,
                    channel_id: el('moderationChannel').value || null
                });
                showBanner('Action de mod√©ration envoy√©e.', false);
                await loadModerationTab();
            }

            async function loadWelcomeTab() {
                if (!state.guildId) return;
                const cfg = await apiCall(`/guild/${state.guildId}/welcome`);
                el('welcomeEnabled').checked = !!cfg.welcome_enabled;
                el('welcomeChannel').value = cfg.welcome_channel || '';
                el('welcomeTitle').value = cfg.welcome_title || '';
                el('welcomeMessage').value = cfg.welcome_message || '';
                el('goodbyeEnabled').checked = !!cfg.goodbye_enabled;
                el('goodbyeChannel').value = cfg.goodbye_channel || '';
                el('goodbyeTitle').value = cfg.goodbye_title || '';
                el('goodbyeMessage').value = cfg.goodbye_message || '';
            }
            async function saveWelcomeTab() {
                if (!state.guildId) return;
                await apiCall(`/guild/${state.guildId}/welcome`, 'PUT', {
                    welcome_enabled: el('welcomeEnabled').checked,
                    welcome_channel: el('welcomeChannel').value || null,
                    welcome_title: el('welcomeTitle').value || 'üëã Nouveau membre !',
                    welcome_message: el('welcomeMessage').value || 'Bienvenue {user} sur {server} !',
                    welcome_fields: null,
                    welcome_image_url: null,
                    goodbye_enabled: el('goodbyeEnabled').checked,
                    goodbye_channel: el('goodbyeChannel').value || null,
                    goodbye_title: el('goodbyeTitle').value || 'üëã D√©part',
                    goodbye_message: el('goodbyeMessage').value || 'Au revoir {user}, tu vas nous manquer !',
                    goodbye_fields: null,
                    goodbye_image_url: null,
                    auto_role_enabled: false,
                    auto_role_ids: []
                });
                showBanner('Param√®tres de bienvenue sauvegard√©s.', false);
            }

            async function loadRoleMenusTab() {
                if (!state.guildId) return;
                const data = await apiCall(`/guild/${state.guildId}/role-menus`);
                const menus = data.menus || [];
                state.roleMenus = menus;
                const container = el('roleMenusList');
                container.innerHTML = menus.length
                    ? menus.map(menu => `<div style="padding:10px;border:1px solid rgba(255,255,255,.08);margin-bottom:8px;"><strong>${menu.title}</strong> <span style="color:#a1a1aa;">#${menu.channel_name || 'inconnu'}</span><div style="margin-top:8px;color:#a1a1aa;font-size:.8rem;">${menu.options_count || 0} option(s)</div><div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;"><button class="btn" data-edit-menu="${menu.id}">Modifier</button><button class="btn" data-send-menu="${menu.id}">Envoyer</button><button class="btn" data-delete-menu="${menu.id}">Supprimer</button></div></div>`).join('')
                    : 'Aucun menu de r√¥les.';
                container.querySelectorAll('[data-edit-menu]').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        await openRoleMenuEditor(btn.dataset.editMenu);
                    });
                });
                container.querySelectorAll('[data-send-menu]').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        await sendRoleMenu(btn.dataset.sendMenu);
                    });
                });
                container.querySelectorAll('[data-delete-menu]').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        if (!window.confirm('Supprimer ce menu de r√¥les ?')) return;
                        await apiCall(`/guild/${state.guildId}/role-menus/${btn.dataset.deleteMenu}`, 'DELETE');
                        if (String(state.editingRoleMenuId) === String(btn.dataset.deleteMenu)) closeRoleMenuEditor();
                        await loadRoleMenusTab();
                    });
                });
            }

            function textChannels() {
                return state.channels.filter(ch => ch.type === 0 || ch.type === 5 || ch.type === undefined);
            }

            function createRoleOptionRow(optionData = null) {
                const row = document.createElement('div');
                row.className = 'section-grid';
                row.style.marginBottom = '10px';
                row.style.padding = '10px';
                row.style.border = '1px solid rgba(255,255,255,.08)';
                const roleOptions = ['<option value="">S√©lectionner un r√¥le...</option>']
                    .concat(state.roles.filter(r => r.name !== '@everyone').map(role => `<option value="${role.id}">${role.name}</option>`))
                    .join('');
                row.innerHTML = `
                    <div>
                        <div class="row"><label class="label">R√¥le</label><select class="form-select role-option-role">${roleOptions}</select></div>
                        <div class="row"><label class="label">Libell√©</label><input class="input role-option-label" type="text" maxlength="80"></div>
                    </div>
                    <div>
                        <div class="row"><label class="label">Description</label><input class="input role-option-description" type="text" maxlength="100"></div>
                        <div class="row"><label class="label">Emoji</label><input class="input role-option-emoji" type="text" maxlength="20"></div>
                        <div class="actions" style="justify-content:flex-end;"><button class="btn role-option-remove" type="button">Supprimer</button></div>
                    </div>
                `;
                row.querySelector('.role-option-remove').addEventListener('click', () => row.remove());
                if (optionData) {
                    row.querySelector('.role-option-role').value = String(optionData.role_id || '');
                    row.querySelector('.role-option-label').value = optionData.label || '';
                    row.querySelector('.role-option-description').value = optionData.description || '';
                    row.querySelector('.role-option-emoji').value = optionData.emoji || '';
                }
                return row;
            }

            function closeRoleMenuEditor() {
                state.editingRoleMenuId = null;
                el('roleMenuEditorCard').style.display = 'none';
                el('roleOptionsList').innerHTML = '';
            }

            async function openRoleMenuEditor(menuId = null) {
                if (!state.guildId) return;
                state.editingRoleMenuId = menuId ? String(menuId) : null;
                const menu = menuId ? (await apiCall(`/guild/${state.guildId}/role-menus/${menuId}`)).menu : null;
                const channelOpts = ['<option value="">S√©lectionner un salon...</option>']
                    .concat(textChannels().map(ch => `<option value="${ch.id}">#${ch.name}</option>`))
                    .join('');
                el('menuChannel').innerHTML = channelOpts;

                el('menuTitle').value = menu?.title || '';
                el('menuDescription').value = menu?.description || '';
                el('menuColor').value = menu?.color || '#5865F2';
                el('menuPlaceholder').value = menu?.placeholder || 'S√©lectionner un r√¥le...';
                el('selectionMode').value = (menu?.max_values ?? 1) > 1 ? 'multiple' : 'single';
                el('maxValues').value = (menu?.max_values ?? 1) > 1 ? (menu?.max_values ?? 5) : 1;
                el('maxValuesGroup').style.display = el('selectionMode').value === 'multiple' ? 'block' : 'none';
                el('menuChannel').value = menu?.channel_id ? String(menu.channel_id) : '';
                el('roleMenuEditorTitle').textContent = menu ? 'Modifier un menu de r√¥les' : 'Cr√©er un menu de r√¥les';

                const optionsList = el('roleOptionsList');
                optionsList.innerHTML = '';
                if (menu?.options?.length) {
                    menu.options.forEach(opt => optionsList.appendChild(createRoleOptionRow(opt)));
                } else {
                    optionsList.appendChild(createRoleOptionRow());
                }

                el('roleMenuEditorCard').style.display = 'block';
            }

            async function saveRoleMenuEditor() {
                if (!state.guildId) return;
                const menuData = {
                    title: (el('menuTitle').value || '').trim(),
                    channel_id: el('menuChannel').value || null,
                    description: (el('menuDescription').value || '').trim() || null,
                    color: (el('menuColor').value || '#5865F2').trim(),
                    placeholder: (el('menuPlaceholder').value || 'S√©lectionner un r√¥le...').trim(),
                    min_values: 0,
                    max_values: el('selectionMode').value === 'multiple' ? Number(el('maxValues').value || 1) : 1
                };
                if (!menuData.title || !menuData.channel_id) {
                    showBanner('Le titre et le salon du menu de r√¥les sont requis.');
                    return;
                }

                const optionRows = Array.from(document.querySelectorAll('#roleOptionsList .section-grid'));
                const options = [];
                for (let index = 0; index < optionRows.length; index++) {
                    const row = optionRows[index];
                    const roleId = row.querySelector('.role-option-role').value;
                    const label = (row.querySelector('.role-option-label').value || '').trim();
                    if (!roleId || !label) {
                        showBanner('Chaque option de r√¥le doit contenir un r√¥le et un libell√©.');
                        return;
                    }
                    options.push({
                        role_id: roleId,
                        label,
                        description: (row.querySelector('.role-option-description').value || '').trim() || null,
                        emoji: (row.querySelector('.role-option-emoji').value || '').trim() || null,
                        position: index
                    });
                }
                if (!options.length) {
                    showBanner('Ajoute au moins une option de r√¥le.');
                    return;
                }

                const isEdit = !!state.editingRoleMenuId;
                const path = isEdit ? `/guild/${state.guildId}/role-menus/${state.editingRoleMenuId}` : `/guild/${state.guildId}/role-menus`;
                const method = isEdit ? 'PUT' : 'POST';
                await apiCall(path, method, { menu: menuData, options });
                showBanner(isEdit ? 'Menu de r√¥les mis √† jour.' : 'Menu de r√¥les cr√©√©.', false);
                closeRoleMenuEditor();
                await loadRoleMenusTab();
            }

            async function sendRoleMenu(menuId) {
                if (!state.guildId) return;
                await apiCall(`/guild/${state.guildId}/role-menus/${menuId}/send`, 'POST');
                showBanner('Menu de r√¥les envoy√© sur Discord.', false);
                await loadRoleMenusTab();
            }

            async function loadLogsTab() {
                if (!state.guildId) return;
                const cfg = await apiCall(`/guild/${state.guildId}/logs`);
                el('serverLogsEnabled').checked = !!cfg.enabled;
                el('serverLogsChannel').value = cfg.channel_id || '';
                el('logMessageDelete').checked = !!cfg.message_delete;
                el('logMessageEdit').checked = !!cfg.message_edit;
                el('logMemberJoin').checked = !!cfg.member_join;
                el('logMemberLeave').checked = !!cfg.member_leave;
            }
            async function saveLogsTab() {
                if (!state.guildId) return;
                await apiCall(`/guild/${state.guildId}/logs`, 'PUT', {
                    enabled: el('serverLogsEnabled').checked,
                    channel_id: el('serverLogsChannel').value || null,
                    message_delete: el('logMessageDelete').checked,
                    message_edit: el('logMessageEdit').checked,
                    member_join: el('logMemberJoin').checked,
                    member_leave: el('logMemberLeave').checked,
                    member_update: true,
                    voice_state_update: true,
                    role_create: true,
                    role_delete: true,
                    role_update: true,
                    channel_create: true,
                    channel_delete: true,
                    channel_update: true
                });
                showBanner('Param√®tres de logs sauvegard√©s.', false);
            }

            async function loadTicketsTab() {
                if (!state.guildId) return;
                const data = await apiCall(`/guild/${state.guildId}/tickets`);
                el('ticketSystemEnabled').checked = !!data.enabled;
                const panels = data.panels || [];
                state.ticketPanels = panels;
                el('ticketPanelsList').innerHTML = panels.length
                    ? panels.map(p => {
                        const deployOptions = ['<option value="">Salon de d√©ploiement...</option>']
                            .concat(textChannels().map(ch => `<option value="${ch.id}" ${String(p.channel_id || '') === String(ch.id) ? 'selected' : ''}>#${ch.name}</option>`))
                            .join('');
                        return `<div style="padding:10px;border:1px solid rgba(255,255,255,.08);margin-bottom:8px;"><strong>${p.panel_name}</strong> <span style="color:#a1a1aa;">(${(p.buttons || []).length} bouton(s) ‚Ä¢ ${p.message_id ? 'd√©ploy√©' : 'non d√©ploy√©'})</span><div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;"><button class="btn" data-edit-ticket-panel="${p.id}">Modifier</button><button class="btn" data-delete-ticket-panel="${p.id}">Supprimer</button><select class="form-select" data-deploy-channel="${p.id}" style="max-width:220px;">${deployOptions}</select><button class="btn" data-deploy-ticket-panel="${p.id}">D√©ployer</button></div></div>`;
                    }).join('')
                    : 'Aucun panel pour le moment.';
                el('ticketPanelsList').querySelectorAll('[data-edit-ticket-panel]').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        await openTicketPanelEditor(btn.dataset.editTicketPanel);
                    });
                });
                el('ticketPanelsList').querySelectorAll('[data-delete-ticket-panel]').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        if (!window.confirm('Supprimer ce panel ticket ?')) return;
                        await apiCall(`/guild/${state.guildId}/tickets/panels/${btn.dataset.deleteTicketPanel}`, 'DELETE');
                        if (String(state.editingTicketPanelId) === String(btn.dataset.deleteTicketPanel)) closeTicketPanelEditor();
                        await loadTicketsTab();
                    });
                });
                el('ticketPanelsList').querySelectorAll('[data-deploy-ticket-panel]').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const panelId = btn.dataset.deployTicketPanel;
                        const channelSelect = document.querySelector(`[data-deploy-channel="${panelId}"]`);
                        const channelId = channelSelect?.value;
                        if (!channelId) {
                            showBanner('Choisis un salon avant de d√©ployer.');
                            return;
                        }
                        await apiCall(`/guild/${state.guildId}/tickets/panels/${panelId}/deploy`, 'POST', { channel_id: channelId });
                        showBanner('Panel ticket d√©ploy√©.', false);
                        await loadTicketsTab();
                    });
                });
            }

            function populateVerificationSelectors(panel = null) {
                const roleOptions = state.roles
                    .filter(role => role.name !== '@everyone')
                    .map(role => `<option value="${role.id}">${role.name}</option>`)
                    .join('');
                const verifier = el('verifierRole');
                verifier.innerHTML = `<option value="">Aucun</option>${roleOptions}`;
                el('rolesToRemove').innerHTML = roleOptions;
                el('rolesToAdd').innerHTML = roleOptions;

                const channels = ['<option value="">S√©lectionner un salon...</option>']
                    .concat(textChannels().map(ch => `<option value="${ch.id}">#${ch.name}</option>`))
                    .join('');
                el('verificationChannel').innerHTML = channels;

                if (!panel) return;
                el('verifierRole').value = panel.verifier_role_id || '';
                Array.from(el('rolesToRemove').options).forEach(opt => { opt.selected = (panel.roles_to_remove || []).includes(opt.value); });
                Array.from(el('rolesToAdd').options).forEach(opt => { opt.selected = (panel.roles_to_add || []).includes(opt.value); });
                el('verificationChannel').value = panel.verification_channel || '';
            }

            function createTicketButtonRow(buttonData = null) {
                const row = document.createElement('div');
                row.className = 'card';
                row.style.marginBottom = '10px';
                const categoryOptions = ['<option value="">Aucune cat√©gorie</option>']
                    .concat((state.categories || []).map(cat => `<option value="${cat.id}">${cat.name}</option>`))
                    .join('');
                const roleOptions = (state.roles || [])
                    .filter(role => role.name !== '@everyone')
                    .map(role => `<option value="${role.id}">${role.name}</option>`)
                    .join('');
                row.innerHTML = `
                    <div class="section-grid">
                        <div>
                            <div class="row"><label class="label">Label</label><input class="input ticket-button-label" type="text"></div>
                            <div class="row"><label class="label">Emoji</label><input class="input ticket-button-emoji" type="text"></div>
                            <div class="row"><label class="label">Style</label><select class="form-select ticket-button-style"><option value="primary">Principal</option><option value="secondary">Secondaire</option><option value="success">Succ√®s</option><option value="danger">Danger</option></select></div>
                        </div>
                        <div>
                            <div class="row"><label class="label">Cat√©gorie</label><select class="form-select ticket-button-category">${categoryOptions}</select></div>
                            <div class="row"><label class="label">Format du nom de ticket</label><input class="input ticket-button-name-format" type="text" value="ticket-{username}"></div>
                            <div class="row"><label class="label">R√¥les √† notifier</label><select class="form-select ticket-button-ping-roles" multiple>${roleOptions}</select></div>
                        </div>
                    </div>
                    <div class="row"><label class="label">Message initial</label><textarea class="textarea ticket-button-initial-message" rows="2"></textarea></div>
                    <div class="actions" style="justify-content:flex-end;"><button class="btn ticket-button-remove" type="button">Supprimer le bouton</button></div>
                `;
                row.querySelector('.ticket-button-remove').addEventListener('click', () => row.remove());
                if (buttonData) {
                    row.querySelector('.ticket-button-label').value = buttonData.button_label || '';
                    row.querySelector('.ticket-button-emoji').value = buttonData.button_emoji || '';
                    row.querySelector('.ticket-button-style').value = buttonData.button_style || 'primary';
                    row.querySelector('.ticket-button-category').value = buttonData.category_id || '';
                    row.querySelector('.ticket-button-name-format').value = buttonData.ticket_name_format || 'ticket-{username}';
                    row.querySelector('.ticket-button-initial-message').value = buttonData.initial_message || '';
                    const pingRoles = buttonData.ping_roles || [];
                    Array.from(row.querySelector('.ticket-button-ping-roles').options).forEach(opt => {
                        opt.selected = pingRoles.includes(opt.value);
                    });
                }
                return row;
            }

            function closeTicketPanelEditor() {
                state.editingTicketPanelId = null;
                el('ticketPanelEditorCard').style.display = 'none';
                el('ticketButtonsList').innerHTML = '';
            }

            async function openTicketPanelEditor(panelId = null) {
                if (!state.guildId) return;
                state.editingTicketPanelId = panelId ? String(panelId) : null;
                const panel = panelId ? (state.ticketPanels || []).find(p => String(p.id) === String(panelId)) : null;
                if (panelId && !panel) {
                    showBanner('Panel introuvable.');
                    return;
                }

                el('ticketPanelName').value = panel?.panel_name || '';
                el('ticketEmbedTitle').value = panel?.embed_title || 'üé´ Tickets Support';
                el('ticketEmbedDescription').value = panel?.embed_description || 'Clique sur un bouton ci-dessous pour cr√©er un ticket support';
                el('ticketEmbedColor').value = panel?.embed_color || '#5865F2';
                el('ticketEmbedThumbnail').value = panel?.embed_thumbnail || '';
                el('ticketEmbedImage').value = panel?.embed_image || '';
                el('ticketEmbedFooter').value = panel?.embed_footer || '';

                el('panelVerification').checked = !!panel?.verification_enabled;
                el('verificationOptionsContainer').style.display = el('panelVerification').checked ? 'block' : 'none';
                populateVerificationSelectors(panel);
                el('verificationMessage').value = panel?.verification_message || '';
                el('verificationImageUrl').value = panel?.verification_image_url || '';

                const buttonList = el('ticketButtonsList');
                buttonList.innerHTML = '';
                if (panel?.buttons?.length) {
                    panel.buttons.forEach(btn => buttonList.appendChild(createTicketButtonRow(btn)));
                } else {
                    buttonList.appendChild(createTicketButtonRow());
                }

                el('ticketPanelEditorTitle').textContent = panel ? 'Modifier un panel ticket' : 'Cr√©er un panel ticket';
                el('ticketPanelEditorCard').style.display = 'block';
            }

            async function saveTicketsEnabled() {
                if (!state.guildId) return;
                await apiCall(`/guild/${state.guildId}/tickets`, 'PUT', { enabled: el('ticketSystemEnabled').checked, panels: [] });
                showBanner('Syst√®me de tickets mis √† jour.', false);
            }

            async function saveTicketPanelEditor() {
                if (!state.guildId) return;
                const panelName = (el('ticketPanelName').value || '').trim();
                if (!panelName) {
                    showBanner('Le nom du panel est requis.');
                    return;
                }
                const buttonRows = Array.from(document.querySelectorAll('#ticketButtonsList > .card'));
                if (!buttonRows.length) {
                    showBanner('Au moins un bouton est requis.');
                    return;
                }
                const buttons = [];
                for (let index = 0; index < buttonRows.length; index++) {
                    const row = buttonRows[index];
                    const label = (row.querySelector('.ticket-button-label').value || '').trim();
                    if (!label) {
                        showBanner('Chaque bouton doit avoir un libell√©.');
                        return;
                    }
                    buttons.push({
                        button_label: label,
                        button_emoji: (row.querySelector('.ticket-button-emoji').value || '').trim() || null,
                        button_style: row.querySelector('.ticket-button-style').value || 'primary',
                        category_id: row.querySelector('.ticket-button-category').value || null,
                        ticket_name_format: (row.querySelector('.ticket-button-name-format').value || 'ticket-{username}').trim(),
                        ping_roles: Array.from(row.querySelector('.ticket-button-ping-roles').selectedOptions).map(opt => opt.value),
                        initial_message: (row.querySelector('.ticket-button-initial-message').value || '').trim() || null,
                        button_order: index
                    });
                }

                const payload = {
                    panel_name: panelName,
                    embed_title: (el('ticketEmbedTitle').value || '').trim() || 'üé´ Tickets Support',
                    embed_description: (el('ticketEmbedDescription').value || '').trim() || 'Clique sur un bouton ci-dessous pour cr√©er un ticket support',
                    embed_color: el('ticketEmbedColor').value || '#5865F2',
                    embed_thumbnail: (el('ticketEmbedThumbnail').value || '').trim() || null,
                    embed_image: (el('ticketEmbedImage').value || '').trim() || null,
                    embed_footer: (el('ticketEmbedFooter').value || '').trim() || null,
                    buttons,
                    verification_enabled: el('panelVerification').checked,
                    verifier_role_id: el('verifierRole').value || null,
                    roles_to_remove: Array.from(el('rolesToRemove').selectedOptions).map(opt => opt.value),
                    roles_to_add: Array.from(el('rolesToAdd').selectedOptions).map(opt => opt.value),
                    verification_channel: el('verificationChannel').value || null,
                    verification_message: (el('verificationMessage').value || '').trim() || null,
                    verification_image_url: (el('verificationImageUrl').value || '').trim() || null
                };

                if (state.editingTicketPanelId) {
                    await apiCall(`/guild/${state.guildId}/tickets/panels/${state.editingTicketPanelId}`, 'PUT', payload);
                    showBanner('Panel ticket mis √† jour.', false);
                } else {
                    await apiCall(`/guild/${state.guildId}/tickets/panels`, 'POST', payload);
                    showBanner('Panel ticket cr√©√©.', false);
                }

                closeTicketPanelEditor();
                await loadTicketsTab();
            }

            function createRulesFieldRow(field = null) {
                const row = document.createElement('div');
                row.className = 'section-grid';
                row.style.marginBottom = '10px';
                row.style.padding = '10px';
                row.style.border = '1px solid rgba(255,255,255,.08)';
                row.innerHTML = `
                    <div>
                        <div class="row"><label class="label">Nom du champ</label><input class="input rules-field-name" type="text" maxlength="256"></div>
                        <div class="row"><label class="label">Valeur</label><textarea class="textarea rules-field-value" rows="2" maxlength="1024"></textarea></div>
                    </div>
                    <div>
                        <div class="row"><label class="label">En ligne</label><input class="rules-field-inline" type="checkbox"></div>
                        <div class="actions" style="justify-content:flex-end;"><button class="btn rules-field-remove" type="button">Supprimer</button></div>
                    </div>
                `;
                row.querySelector('.rules-field-remove').addEventListener('click', () => row.remove());
                if (field) {
                    row.querySelector('.rules-field-name').value = field.name || '';
                    row.querySelector('.rules-field-value').value = field.value || '';
                    row.querySelector('.rules-field-inline').checked = !!field.inline;
                }
                return row;
            }

            function collectRulesFields() {
                const rows = Array.from(document.querySelectorAll('#rulesFieldsList .section-grid'));
                const fields = [];
                for (const row of rows) {
                    const name = (row.querySelector('.rules-field-name').value || '').trim();
                    const value = (row.querySelector('.rules-field-value').value || '').trim();
                    const inline = !!row.querySelector('.rules-field-inline').checked;
                    if (!name && !value) continue;
                    if (!name || !value) {
                        throw new Error('Chaque champ du r√®glement doit contenir un nom et une valeur.');
                    }
                    fields.push({ name, value, inline });
                }
                return fields;
            }

            async function loadRulesTab() {
                if (!state.guildId) return;
                const cfg = await apiCall(`/guild/${state.guildId}/rules`);
                state.rulesConfig = cfg;

                el('rulesChannel').value = cfg.rules_channel_id || '';
                el('rulesTitle').value = cfg.rules_title || 'üìò R√®glement du serveur';
                el('rulesDescription').value = cfg.rules_description || 'Merci de lire et valider le r√®glement via le bouton ci-dessous.';
                el('rulesColor').value = cfg.rules_color || '#5865F2';
                el('rulesThumbnail').value = cfg.rules_thumbnail_url || '';
                el('rulesImage').value = cfg.rules_image_url || '';
                el('rulesFooter').value = cfg.rules_footer || '';
                el('rulesButtonLabel').value = cfg.button_label || "J'accepte";
                el('rulesButtonEmoji').value = cfg.button_emoji || '‚úÖ';
                el('rulesButtonStyle').value = cfg.button_style || 'success';

                el('rulesGrantRole').value = cfg.grant_role_id || '';
                el('rulesWelcomeEnabled').checked = !!cfg.welcome_enabled;
                el('rulesWelcomeChannel').value = cfg.welcome_channel_id || '';
                el('rulesWelcomeTitle').value = cfg.welcome_embed_title || 'Bienvenue {username} !';
                el('rulesWelcomeDescription').value = cfg.welcome_embed_description || '{user} vient de valider le r√®glement.';
                el('rulesWelcomeColor').value = cfg.welcome_embed_color || '#5865F2';
                el('rulesWelcomeThumbnail').value = cfg.welcome_embed_thumbnail_url || '{avatar}';
                el('rulesWelcomeImage').value = cfg.welcome_embed_image_url || '';
                el('rulesWelcomeFooter').value = cfg.welcome_embed_footer || 'Profite bien de ton arriv√©e !';

                const fieldsList = el('rulesFieldsList');
                fieldsList.innerHTML = '';
                if (Array.isArray(cfg.rules_fields) && cfg.rules_fields.length) {
                    cfg.rules_fields.forEach(field => fieldsList.appendChild(createRulesFieldRow(field)));
                }
            }

            function buildRulesPayload() {
                const rulesFields = collectRulesFields();
                return {
                    rules_channel_id: el('rulesChannel').value || null,
                    rules_message_id: state.rulesConfig?.rules_message_id || null,
                    rules_title: (el('rulesTitle').value || '').trim() || 'üìò R√®glement du serveur',
                    rules_description: (el('rulesDescription').value || '').trim() || 'Merci de lire et valider le r√®glement via le bouton ci-dessous.',
                    rules_fields: rulesFields,
                    rules_color: el('rulesColor').value || '#5865F2',
                    rules_thumbnail_url: (el('rulesThumbnail').value || '').trim() || null,
                    rules_image_url: (el('rulesImage').value || '').trim() || null,
                    rules_footer: (el('rulesFooter').value || '').trim() || null,
                    button_label: (el('rulesButtonLabel').value || '').trim() || "J'accepte",
                    button_emoji: (el('rulesButtonEmoji').value || '').trim() || null,
                    button_style: el('rulesButtonStyle').value || 'success',
                    grant_role_id: el('rulesGrantRole').value || null,
                    welcome_channel_id: el('rulesWelcomeChannel').value || null,
                    welcome_enabled: el('rulesWelcomeEnabled').checked,
                    welcome_embed_title: (el('rulesWelcomeTitle').value || '').trim() || 'Bienvenue {username} !',
                    welcome_embed_description: (el('rulesWelcomeDescription').value || '').trim() || '{user} vient de valider le r√®glement.',
                    welcome_embed_color: el('rulesWelcomeColor').value || '#5865F2',
                    welcome_embed_thumbnail_url: (el('rulesWelcomeThumbnail').value || '').trim() || '{avatar}',
                    welcome_embed_image_url: (el('rulesWelcomeImage').value || '').trim() || null,
                    welcome_embed_footer: (el('rulesWelcomeFooter').value || '').trim() || 'Profite bien de ton arriv√©e !'
                };
            }

            async function saveRulesTab() {
                if (!state.guildId) return;
                let payload;
                try {
                    payload = buildRulesPayload();
                } catch (err) {
                    showBanner(err.message || 'Erreur de validation des champs.');
                    return;
                }
                await apiCall(`/guild/${state.guildId}/rules`, 'PUT', payload);
                showBanner('Configuration du r√®glement sauvegard√©e.', false);
                await loadRulesTab();
            }

            async function deployRulesTab() {
                if (!state.guildId) return;
                await saveRulesTab();
                const res = await apiCall(`/guild/${state.guildId}/rules/deploy`, 'POST');
                showBanner(res.message || 'R√®glement publi√©.', false);
                await loadRulesTab();
            }

            async function searchTicketLogs() {
                if (!state.guildId) return;
                const query = (el('ticketSearchInput').value || '').trim();
                if (!query) return;
                const usersResp = await apiCall(`/ticket-logs/search-users?query=${encodeURIComponent(query)}&guild_id=${encodeURIComponent(state.guildId)}`);
                const users = usersResp.users || [];
                if (!users.length) {
                    el('ticketSearchResults').innerHTML = 'Aucun utilisateur trouv√©.';
                    return;
                }
                const user = users[0];
                const ticketsResp = await apiCall(`/ticket-logs/user-tickets/${encodeURIComponent(user.id)}?guild_id=${encodeURIComponent(state.guildId)}`);
                const tickets = ticketsResp.tickets || [];
                el('ticketSearchResults').innerHTML = tickets.length
                    ? tickets.map(t => `<div style="padding:8px;border:1px solid rgba(255,255,255,.08);margin-bottom:8px;">${t.ticket_id || t.file_id} - ${t.status || 'inconnu'} - ${t.created_at || ''}</div>`).join('')
                    : 'Aucun ticket pour cet utilisateur.';
            }

            async function sendEmbed() {
                if (!state.guildId) return;
                const target = el('embedTargetChannel').value;
                if (!target) { showBanner('S√©lectionne un salon cible pour l\'embed.'); return; }
                await apiCall(`/guild/${state.guildId}/embed/send`, 'POST', {
                    target_channel: target,
                    title: el('embedTitle').value || null,
                    description: el('embedDescription').value || null,
                    color: el('embedColor').value || '#5865F2',
                    thumbnail_url: el('embedThumbnail').value || null,
                    image_url: el('embedImage').value || null,
                    fields: []
                });
                showBanner('Embed envoy√© avec succ√®s.', false);
            }

            async function loadTabData(tabId) {
                if (!state.guildId) return;
                if (tabId === 'overview') return loadOverview();
                if (tabId === 'xp-settings') return loadXpTab();
                if (tabId === 'moderation') return loadModerationTab();
                if (tabId === 'welcome') return loadWelcomeTab();
                if (tabId === 'role-menus') return loadRoleMenusTab();
                if (tabId === 'logs') return loadLogsTab();
                if (tabId === 'tickets') return loadTicketsTab();
                if (tabId === 'rules') return loadRulesTab();
            }

            function bindActions() {
                document.querySelectorAll('[data-chart="memberGrowth"][data-period]').forEach(btn => btn.addEventListener('click', async () => {
                    document.querySelectorAll('[data-chart="memberGrowth"]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.memberGrowthPeriod = btn.dataset.period;
                    await loadMemberGrowthChart();
                }));
                document.querySelectorAll('[data-chart="activity"][data-period]').forEach(btn => btn.addEventListener('click', async () => {
                    document.querySelectorAll('[data-chart="activity"]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.activityPeriod = btn.dataset.period;
                    await loadActivityChart();
                }));
                document.querySelectorAll('[data-chart="xpEvolution"][data-period]').forEach(btn => btn.addEventListener('click', async () => {
                    document.querySelectorAll('[data-chart="xpEvolution"]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.xpEvolutionPeriod = btn.dataset.period;
                    await loadXpEvolutionChart();
                }));

                el('refreshXpDistribution').addEventListener('click', loadXpDistributionChart);
                el('saveXpSettingsBtn').addEventListener('click', () => saveXpTab().catch(e => showBanner(e.message)));
                el('testLevelUpBtn').addEventListener('click', async () => {
                    try {
                        const res = await apiCall(`/guild/${state.guildId}/xp/test-levelup`, 'POST');
                        showBanner(res.message || 'Test envoy√©.', !res.success);
                    } catch (e) { showBanner(e.message); }
                });

                el('moderationAction').addEventListener('change', () => {
                    el('timeoutDuration').style.display = el('moderationAction').value === 'timeout' ? 'block' : 'none';
                });
                el('executeModerationBtn').addEventListener('click', () => executeModeration().catch(e => showBanner(e.message)));

                el('saveWelcomeBtn').addEventListener('click', () => saveWelcomeTab().catch(e => showBanner(e.message)));
                el('testWelcomeBtn').addEventListener('click', async () => {
                    try {
                        const res = await apiCall(`/guild/${state.guildId}/welcome/test`, 'POST');
                        showBanner(res.message || 'Test de bienvenue envoy√©.', !res.success);
                    } catch (e) { showBanner(e.message); }
                });

                el('refreshRoleMenusBtn').addEventListener('click', () => loadRoleMenusTab().catch(e => showBanner(e.message)));
                el('createRoleMenuBtn').addEventListener('click', () => openRoleMenuEditor().catch(e => showBanner(e.message)));
                el('selectionMode').addEventListener('change', () => {
                    const multi = el('selectionMode').value === 'multiple';
                    el('maxValuesGroup').style.display = multi ? 'block' : 'none';
                    if (!multi) el('maxValues').value = 1;
                });
                el('addRoleOptionBtn').addEventListener('click', () => {
                    el('roleOptionsList').appendChild(createRoleOptionRow());
                });
                el('saveRoleMenuBtn').addEventListener('click', () => saveRoleMenuEditor().catch(e => showBanner(e.message)));
                el('cancelRoleMenuBtn').addEventListener('click', closeRoleMenuEditor);

                el('saveLogSettingsBtn').addEventListener('click', () => saveLogsTab().catch(e => showBanner(e.message)));
                el('ticketSystemEnabled').addEventListener('change', () => saveTicketsEnabled().catch(e => showBanner(e.message)));
                el('createTicketPanelBtn').addEventListener('click', () => openTicketPanelEditor().catch(e => showBanner(e.message)));
                el('addTicketButtonBtn').addEventListener('click', () => {
                    el('ticketButtonsList').appendChild(createTicketButtonRow());
                });
                el('panelVerification').addEventListener('change', () => {
                    el('verificationOptionsContainer').style.display = el('panelVerification').checked ? 'block' : 'none';
                });
                el('saveTicketPanelBtn').addEventListener('click', () => saveTicketPanelEditor().catch(e => showBanner(e.message)));
                el('cancelTicketPanelBtn').addEventListener('click', closeTicketPanelEditor);
                el('addRulesFieldBtn').addEventListener('click', () => {
                    el('rulesFieldsList').appendChild(createRulesFieldRow());
                });
                el('saveRulesBtn').addEventListener('click', () => saveRulesTab().catch(e => showBanner(e.message)));
                el('deployRulesBtn').addEventListener('click', () => deployRulesTab().catch(e => showBanner(e.message)));
                el('searchTicketLogsBtn').addEventListener('click', () => searchTicketLogs().catch(e => showBanner(e.message)));
                el('sendEmbedBtn').addEventListener('click', () => sendEmbed().catch(e => showBanner(e.message)));
                el('previewEmbedBtn').addEventListener('click', () => showBanner('Aper√ßu non impl√©ment√© pour le moment dans cette interface.', false));

                el('logoutBtn').addEventListener('click', () => {
                    document.cookie = 'access_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                    window.location.href = '/';
                });
            }

            async function bootstrap() {
                try {
                    hideBanner();
                    const token = getCookie('access_token');
                    if (!token) { window.location.href = '/'; return; }

                    const user = await apiCall('/user/me');
                    state.user = user;
                    el('username').textContent = user.username || 'Inconnu';
                    const avatar = el('userAvatar');
                    if (user.avatar && user.id) {
                        avatar.src = `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png`;
                        avatar.style.display = 'block';
                    }

                    const selector = el('guildSelector');
                    selector.innerHTML = '<option value="">S√©lectionner un serveur...</option>';
                    (user.guilds || []).forEach(guild => {
                        const opt = document.createElement('option');
                        opt.value = guild.id;
                        opt.textContent = guild.name;
                        selector.appendChild(opt);
                    });

                    selector.addEventListener('change', async (e) => {
                        state.guildId = e.target.value || null;
                        if (!state.guildId) return;
                        try {
                            hideBanner();
                            await loadGuildResources();
                            await loadOverview();
                            await loadXpTab();
                            await loadModerationTab();
                            await loadWelcomeTab();
                            await loadLogsTab();
                            await loadTicketsTab();
                            await loadRulesTab();
                            await loadRoleMenusTab();
                        } catch (err) {
                            showBanner(err.message);
                        }
                    });

                    bindActions();
                    setLoading(false);
                } catch (err) {
                    setLoading(false);
                    showBanner(err.message || '√âchec de l\'initialisation du dashboard.');
                }
            }

            bootstrap();
        })();
    </script>
</body>
</html>
